import{Ac as h,Bc as b,N as f,S as y,m as g,n as s,q as l,y as a}from"./chunk-ZNBC4ISR.js";import{a as u,b as d}from"./chunk-ODN5LVDJ.js";var v={production:!0,apiUrl:"https://backend-conautol.vercel.app/"};var p=class extends Error{};p.prototype.name="InvalidTokenError";function O(i){return decodeURIComponent(atob(i).replace(/(.)/g,(r,e)=>{let t=e.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t="0"+t),"%"+t}))}function S(i){let r=i.replace(/-/g,"+").replace(/_/g,"/");switch(r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return O(r)}catch{return atob(r)}}function $(i,r){if(typeof i!="string")throw new p("Invalid token specified: must be a string");r||(r={});let e=r.header===!0?0:1,t=i.split(".")[e];if(typeof t!="string")throw new p(`Invalid token specified: missing part #${e+1}`);let o;try{o=S(t)}catch(n){throw new p(`Invalid token specified: invalid base64 for part #${e+1} (${n.message})`)}try{return JSON.parse(o)}catch(n){throw new p(`Invalid token specified: invalid json for part #${e+1} (${n.message})`)}}var _=class i{constructor(r){this.http=r}baseUrl=v.apiUrl.replace(/\/$/,"");getToken(){return localStorage.getItem("auth_token")}authHeaderOnly(){let r=this.getToken();return r?new h({Authorization:`Bearer ${r}`}):void 0}buildOptions({isFormData:r=!1}={}){let e=this.authHeaderOnly();if(r)return e?{headers:e}:{};{let t=new h({"Content-Type":"application/json"});return{headers:e?t.set("Authorization",`Bearer ${this.getToken()}`):t}}}toFormData(r){let e=new FormData,t=(o,n)=>{if(n!=null){if(n instanceof Blob||n instanceof File){e.append(o,n);return}if(Array.isArray(n)){n.forEach((c,m)=>{c instanceof Blob||c instanceof File?e.append(`${o}[${m}]`,c):typeof c=="object"&&c!==null?e.append(`${o}[${m}]`,JSON.stringify(c)):e.append(`${o}[${m}]`,String(c))});return}if(typeof n=="object"){e.append(o,JSON.stringify(n));return}e.append(o,String(n))}};return r&&typeof r=="object"&&!(r instanceof FormData)&&Object.keys(r).forEach(o=>t(o,r[o])),e}getProyectos(){return this.http.get(`${this.baseUrl}/api/proyectos/`).pipe(l(r=>r.map(e=>{let t=[];if(e.imagen_urls)if(typeof e.imagen_urls=="string")try{t=JSON.parse(e.imagen_urls)}catch(n){console.warn("Error parseando imagen_urls:",n),t=[]}else Array.isArray(e.imagen_urls)&&(t=e.imagen_urls);let o=t[0]||"";return{id:e.id??0,nombre:e.nombre,descripcion:e.descripcion??"",descripcionCorta:e.descripcion?e.descripcion.substring(0,100)+"...":"",imagen_urls:t,imagenUrl:o,estado:e.estado??"activo",cliente:e.cliente??""}})))}getProyecto(r){return this.http.get(`${this.baseUrl}/api/proyectos/${r}`).pipe(l(e=>{let t=[];if(e.imagen_urls)if(typeof e.imagen_urls=="string")try{t=JSON.parse(e.imagen_urls)}catch(n){console.warn("Error parseando imagen_urls:",n),t=[]}else Array.isArray(e.imagen_urls)&&(t=e.imagen_urls);return d(u({},e),{imagen_urls:t})}),a(e=>(console.error(`\u274C Error fetching proyecto ${r}:`,e),s(()=>e))))}getDetalleProyecto(r){return this.getProyecto(r).pipe(l(e=>{let t=e.imagen_urls||[];return d(u({},e),{imagenPrincipalUrl:t[0]||"",galeria:t})}))}crearProyecto(r){let e=r instanceof FormData?r:(()=>{let t=new FormData;return t.append("data",JSON.stringify(r)),t})();return this.http.post(`${this.baseUrl}/api/proyectos`,e,this.buildOptions({isFormData:!0})).pipe(a(t=>(console.error("Error creating proyecto:",t),s(()=>t))))}actualizarProyecto(r,e){let t=e instanceof FormData?e:(()=>{let o=new FormData;return o.append("data",JSON.stringify(e)),o})();return this.http.put(`${this.baseUrl}/api/proyectos/${r}`,t,this.buildOptions({isFormData:!0})).pipe(a(o=>(console.error(`Error updating proyecto ${r}:`,o),s(()=>o))))}eliminarProyecto(r){return this.http.delete(`${this.baseUrl}/api/proyectos/${r}`,this.buildOptions()).pipe(a(e=>(console.error(`Error deleting proyecto ${r}:`,e),s(()=>e))))}getServicios(){return this.http.get(`${this.baseUrl}/api/servicios/`).pipe(l(r=>r.map(e=>{let t=[];if(e.imagen_urls)if(typeof e.imagen_urls=="string")try{t=JSON.parse(e.imagen_urls)}catch(n){console.warn("Error parseando imagen_urls:",n),t=[]}else Array.isArray(e.imagen_urls)&&(t=e.imagen_urls);t.length===0&&e.imagen_url&&(t=[e.imagen_url]);let o=t[0]||"";return{id:e.id??0,nombre:e.nombre,descripcion:e.descripcion??"",descripcionCorta:e.descripcion?e.descripcion.substring(0,100)+"...":"",imagen_urls:t,imagen_url:e.imagen_url??"",imagenUrl:o,estado:e.activo===!0?"activo":e.activo===!1?"inactivo":"completado",icono:e.icono??null,categoria:e.categoria??null}})))}getServicio(r){return this.http.get(`${this.baseUrl}/api/servicios/${r}`).pipe(l(e=>{let t=[];if(e.imagen_urls)if(typeof e.imagen_urls=="string")try{t=JSON.parse(e.imagen_urls)}catch(n){console.warn("Error parseando imagen_urls:",n),t=[]}else Array.isArray(e.imagen_urls)&&(t=e.imagen_urls);return t.length===0&&e.imagen_url&&(t=[e.imagen_url]),d(u({},e),{imagen_urls:t,imagenUrl:t[0]||e.imagen_url||""})}),a(e=>(console.error(`\u274C Error fetching servicio ${r}:`,e),s(()=>e))))}crearServicio(r){let e=localStorage.getItem("auth_token"),t=e?{Authorization:`Bearer ${e}`}:void 0;return this.http.post(`${this.baseUrl}/api/servicios`,r,{headers:t})}actualizarServicio(r,e){let o=e instanceof FormData?e:this.toFormData(e);return this.http.put(`${this.baseUrl}/api/servicios/${r}`,o,this.buildOptions({isFormData:!0})).pipe(a(n=>(console.error(`Error updating servicio ${r}:`,n),s(()=>n))))}eliminarServicio(r){return this.http.delete(`${this.baseUrl}/api/servicios/${r}`,this.buildOptions()).pipe(a(e=>(console.error(`Error deleting servicio ${r}:`,e),s(()=>e))))}enviarContacto(r){return this.http.post(`${this.baseUrl}/api/contacto`,r,this.buildOptions()).pipe(a(e=>e&&e.status===404?(console.warn("Contacto endpoint no encontrado en backend, usando fallback mock."),g({success:!0})):(console.error("Error al enviar contacto:",e),s(()=>e))))}login(r){return this.http.post(`${this.baseUrl}/api/admin/login`,r,this.buildOptions()).pipe(l(e=>{let t=e?.data?.access_token||null,o=e?.data?.user||null;return t&&this.setToken(t),{token:t,user:o,raw:e}}),a(e=>(console.error("Error en login:",e),s(()=>e))))}recoverPassword(r){return this.http.post(`${this.baseUrl}/api/admin/recover`,{email:r},this.buildOptions()).pipe(a(e=>(console.warn("recoverPassword endpoint no disponible, usando fallback mock."),g({success:!0,message:"Email de recuperaci\xF3n enviado (mock)."}))))}setToken(r){localStorage.setItem("auth_token",r)}isLoggedIn(){let r=this.getToken();if(!r)return!1;try{let t=$(r)?.exp;if(!t)return!0;let o=Math.floor(Date.now()/1e3);return t<o?(this.logoutClientSide(),!1):!0}catch{return this.logoutClientSide(),!1}}logoutClientSide(){localStorage.removeItem("auth_token")}logout(){this.http.post(`${this.baseUrl}/api/admin/logout`,{},this.buildOptions()).subscribe({next:()=>this.logoutClientSide(),error:()=>this.logoutClientSide()})}static \u0275fac=function(e){return new(e||i)(y(b))};static \u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})};export{_ as a};
